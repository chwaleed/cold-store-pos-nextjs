// Cold Store Management System - Prisma Schema
// Database: SQLite
// ORM: Prisma

generator client {
  provider = "prisma-client-js"
}

generator dbml {
  provider = "prisma-dbml-generator"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Customer Model
model Customer {
  id        Int      @id @default(autoincrement())
  name      String
  fatherName String?
  phone     String?
  address   String?
  village   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entryReceipts     EntryReceipt[]
  clearanceReceipts ClearanceReceipt[]
  ledger            Ledger[]

  @@index([name])
  // CNIC was removed (no longer stored)
  @@index([phone])
}

// Product Type Model (e.g., Potato, Onion, Garlic)
model ProductType {
  id                    Int      @id @default(autoincrement())
  name                  String   @unique
  doubleRentAfter30Days Boolean  @default(false) // Enable double rent pricing after 30 days
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  subTypes   ProductSubType[]
  entryItems EntryItem[]
}

// Product SubType Model (e.g., Cardinal, Red, White)
model ProductSubType {
  id            Int      @id @default(autoincrement())
  productTypeId Int
  name          String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  productType ProductType @relation(fields: [productTypeId], references: [id], onDelete: Cascade)
  entryItems  EntryItem[]

  @@unique([productTypeId, name])
  @@index([productTypeId])
}

// Room Model
model Room {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  type      String   // 'COLD' or 'HOT'
  capacity  Int?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entryItems EntryItem[]
}

// Pack Type Model (Bori, Jali)
model PackType {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entryItems EntryItem[]
}

// Entry Receipt Model
model EntryReceipt {
  id              Int      @id @default(autoincrement())
  receiptNo       String   @unique // Format: CS-YYYYMMDD-XXXX
  customerId      Int
  carNo           String
  entryDate       DateTime @default(now())
  storageTillDate DateTime? // Storage end date (default: entryDate + 30 days)
  totalAmount     Float    // Sum of all items (including KJ)
  description     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  customer          Customer           @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items             EntryItem[]
  clearanceReceipts ClearanceReceipt[]

  @@index([customerId])
  @@index([receiptNo])
  @@index([entryDate])
}

// Entry Item Model
model EntryItem {
  id                Int      @id @default(autoincrement())
  entryReceiptId    Int
  productTypeId     Int
  productSubTypeId  Int?
  packTypeId        Int
  roomId            Int
  boxNo             String?
  marka             String?  // Marking/label
  quantity          Float    // Initial quantity
  remainingQuantity Float    // Tracks partial clearances
  unitPrice         Float
  totalPrice        Float    // quantity × unitPrice
  
  // Khali Jali (Empty Crate) fields
  hasKhaliJali      Boolean  @default(false)
  kjQuantity        Float?
  kjUnitPrice       Float?
  kjTotal           Float?   // kjQuantity × kjUnitPrice
  
  grandTotal        Float    // totalPrice + kjTotal
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  entryReceipt   EntryReceipt     @relation(fields: [entryReceiptId], references: [id], onDelete: Cascade)
  productType    ProductType      @relation(fields: [productTypeId], references: [id])
  productSubType ProductSubType?  @relation(fields: [productSubTypeId], references: [id])
  packType       PackType         @relation(fields: [packTypeId], references: [id])
  room           Room             @relation(fields: [roomId], references: [id])
  clearedItems   ClearedItem[]

  @@index([entryReceiptId])
  @@index([productTypeId])
  @@index([roomId])
}

// Clearance Receipt Model
model ClearanceReceipt {
  id              Int      @id @default(autoincrement())
  clearanceNo     String   @unique // Format: CL-YYYYMMDD-XXXX
  customerId      Int
  entryReceiptId  Int
  carNo           String?
  clearanceDate   DateTime @default(now())
  totalRent       Float    // Sum of all item rents
  description     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  customer      Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  entryReceipt  EntryReceipt  @relation(fields: [entryReceiptId], references: [id], onDelete: Cascade)
  clearedItems  ClearedItem[]

  @@index([customerId])
  @@index([clearanceNo])
  @@index([clearanceDate])
}

// Cleared Item Model
model ClearedItem {
  id                  Int      @id @default(autoincrement())
  clearanceReceiptId  Int
  entryItemId         Int
  quantityCleared     Float
  kjQuantityCleared   Float?   // Khali Jali quantity cleared
  daysStored          Int      // Calculated: clearanceDate - entryDate
  rentPerDay          Float    // Rent rate from entry item's unitPrice
  totalRent           Float    // quantityCleared × daysStored × rentPerDay
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  clearanceReceipt ClearanceReceipt @relation(fields: [clearanceReceiptId], references: [id], onDelete: Cascade)
  entryItem        EntryItem        @relation(fields: [entryItemId], references: [id], onDelete: Cascade)

  @@index([clearanceReceiptId])
  @@index([entryItemId])
}

// Ledger Model - Simplified Credit System
model Ledger {
  id           Int      @id @default(autoincrement())
  customerId   Int
  invoiceId    Int?     // Can be EntryReceipt or ClearanceReceipt ID
  description  String   // e.g., "Payment", "Rent Charged", "Discount Given", "Cash Advance"
  debitAmount  Float    @default(0) // Amount customer owes
  creditAmount Float    @default(0) // Amount customer paid
  isDiscount   Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([createdAt])
}

// Expense Category Model
model ExpenseCategory {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  expenses Expense[]

  @@index([name])
}

// Expense Model
model Expense {
  id          Int             @id @default(autoincrement())
  date        DateTime        @default(now())
  categoryId  Int
  amount      Float
  description String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  category ExpenseCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([date])
}

// Settings Model - Key-Value pairs for system configuration
model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

